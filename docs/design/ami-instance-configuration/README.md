# AMI・インスタンス設定機能 設計文書

## 概要

現在の動的Windows Serverバージョン選択機能を廃止し、cdk.jsonによる明示的なAMI・インスタンスタイプ・Key Pair選択機能に変更するための技術設計文書集です。

## 文書構成

### 📋 [要件定義書](../spec/ami-instance-configuration-requirements.md)
- EARS記法による詳細な要件定義
- 機能要件、非機能要件、受け入れ基準
- Edgeケースとエラーハンドリング要件

### 🏗️ [アーキテクチャ設計](architecture.md)
- システム全体のアーキテクチャ概要
- コンポーネント構成と責任分担
- 設計原則とセキュリティ考慮事項

### 🔄 [データフロー図](dataflow.md)
- Mermaid記法による可視化
- 設定読み取りからリソース作成までの流れ
- エラーハンドリングフローの詳細

### 🔧 [インターフェース定義](interfaces.py)
- Python型定義とバリデーション
- 設定オブジェクトとエラークラス
- 使用例とヘルプ機能

### 🏗️ [スタック構成設計](stack-design.md)
- CDKスタック改修の詳細設計
- 各マネージャークラスの実装方針
- ファイル構成と移行戦略

### 📖 [設定例とガイド](configuration-examples.md)
- cdk.json設定例
- エラーパターンと対処法
- 既存設定からの移行ガイド

## 主な変更点

### 🔄 変更内容

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| AMI選択 | `windows-version` + `windows-language` | `ami-id` または `ami-parameter` |
| インスタンスタイプ | 固定 (`t3.medium`) | `instance-type`で任意指定 |
| Key Pair | `key-pair-name`（任意） | `key-pair-name`（任意、継続） |
| 設定検証 | 実行時エラー | 早期検証とエラーメッセージ |

### ✨ 新機能

- **明示的AMI指定**: 直接AMI IDまたはSSMパラメータパス
- **柔軟なインスタンスタイプ**: 用途に応じたサイズ選択
- **OS自動判定**: Windows/Linux用ユーザーデータの自動切り替え
- **強化されたエラーハンドリング**: 詳細なエラーメッセージと解決策

## 設定例

### 基本的な設定

```json
{
  "context": {
    "ami-parameter": "/aws/service/ami-windows-latest/Windows_Server-2022-Japanese-Full-Base",
    "instance-type": "t3.medium"
  }
}
```

### カスタムAMI使用

```json
{
  "context": {
    "ami-id": "ami-0123456789abcdef0",
    "instance-type": "m5.large",
    "key-pair-name": "my-key-pair"
  }
}
```

## 実装フェーズ

### フェーズ1: 基盤実装 ✅
- [ ] 新しい型定義とインターフェース
- [ ] 各マネージャークラス
- [ ] 単体テスト

### フェーズ2: スタック改修
- [ ] SsmEc2RdpStack改修
- [ ] app.py改修
- [ ] 結合テスト

### フェーズ3: 検証・デプロイ
- [ ] 既存環境での動作確認
- [ ] 新設定形式でのテスト
- [ ] ドキュメント更新

## 設計のメリット

### 🎯 柔軟性の向上
- 任意のAMI使用可能
- Windows以外のOS対応
- インスタンスサイズの最適化

### 🛡️ 信頼性の向上
- 早期設定検証
- 明確なエラーメッセージ
- 型安全性の強化

### 🔧 保守性の向上
- 設定の透明性
- コンポーネントの分離
- テストの容易性

### 💰 コスト最適化
- 適切なインスタンスサイズ選択
- 用途別の最適化
- リソース使用量の制御

## サポート・問い合わせ

設計に関する質問や提案がありましたら、以下の方法でお知らせください：

1. **GitHub Issues**: プロジェクトリポジトリでIssueを作成
2. **設計レビュー**: チーム内でのレビューミーティング
3. **実装相談**: 具体的な実装方法について

## 次のステップ

1. **要件確認**: 設計内容の確認と承認
2. **実装開始**: フェーズ1から順次実装
3. **テスト実行**: 各フェーズでの動作確認
4. **本番適用**: 段階的な本番環境への適用

---

*この設計文書は要件に基づいて作成され、実装の指針となります。実装中に発見された問題や改善点は、この設計文書にもフィードバックしてください。*