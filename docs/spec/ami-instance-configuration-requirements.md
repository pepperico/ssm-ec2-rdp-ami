# AMI・インスタンス設定機能 要件定義書

## 概要

現在の動的Windows Serverバージョン選択機能を、cdk.jsonによる任意のAMIおよび任意のインスタンスタイプ選択機能に変更する。これにより、より柔軟なインフラ構成を可能にし、様々なワークロードに対応できるようにする。

## ユーザストーリー

### ストーリー1: 任意のAMI選択

- **である** システム管理者 **として**
- **私は** cdk.jsonで任意のAMI IDまたはSSMパラメータパスを指定 **をしたい**
- **そうすることで** Windows Server以外のOSやカスタムAMIも利用できる

### ストーリー2: 任意のインスタンスタイプ選択

- **である** システム管理者 **として**
- **私は** cdk.jsonで任意のインスタンスタイプを指定 **をしたい**
- **そうすることで** ワークロードに最適なインスタンスサイズを選択できる

### ストーリー3: 既存機能からの移行

- **である** 既存システム利用者 **として**
- **私は** 現在のWindows Server設定を新しい設定形式に移行 **をしたい**
- **そうすることで** 継続してシステムを利用できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムはcdk.jsonで指定されたAMI設定（AMI IDまたはSSMパラメータパス）を読み取らなければならない
- REQ-002: システムはcdk.jsonで指定されたインスタンスタイプ設定を読み取らなければならない
- REQ-003: システムは指定されたAMI設定に基づいてEC2インスタンスを作成しなければならない
- REQ-004: システムは指定されたインスタンスタイプに基づいてEC2インスタンスを作成しなければならない
- REQ-005: システムは既存のWindows Server特有の設定（RDP有効化、ユーザーデータ等）を保持しなければならない

### 条件付き要件

- REQ-101: AMI IDが直接指定されている場合、システムはそのAMI IDを使用しなければならない
- REQ-102: SSMパラメータパスが指定されている場合、システムはSSMパラメータからAMI IDを取得しなければならない
- REQ-103: AMI設定が指定されていない場合、システムはデフォルトのWindows Server 2022 Japanese AMIを使用しなければならない
- REQ-104: インスタンスタイプが指定されていない場合、システムはデフォルトのt3.mediumを使用しなければならない
- REQ-105: Windows系AMIが使用される場合、システムは既存のWindows特有のユーザーデータスクリプトを適用しなければならない

### 状態要件

- REQ-201: cdk.jsonファイルが存在する場合、システムは設定値を読み取らなければならない
- REQ-202: AMI設定が有効な形式でない場合、システムは適切なエラーメッセージを表示しなければならない
- REQ-203: インスタンスタイプ設定が有効でない場合、システムは適切なエラーメッセージを表示しなければならない

### オプション要件

- REQ-301: システムは複数のインスタンス作成をサポートしてもよい
- REQ-302: システムはAMI設定の妥当性チェック機能を提供してもよい

### 制約要件

- REQ-401: システムは既存のVPCエンドポイント、セキュリティグループ、IAMロール設定を変更してはならない
- REQ-402: システムはSSM Session Manager接続機能を維持しなければならない
- REQ-403: システムは後方互換性を保ち、既存のcdk.json設定でも動作しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: AMI情報の取得処理は30秒以内に完了すること
- NFR-002: インスタンス起動時間は従来と同等であること

### セキュリティ

- NFR-101: 指定されたAMIが存在しない場合、機密情報を含まないエラーメッセージを表示すること
- NFR-102: SSMパラメータアクセスには適切なIAM権限が設定されていること

### ユーザビリティ

- NFR-201: cdk.json設定形式は直感的で理解しやすいものであること
- NFR-202: エラーメッセージは問題解決に役立つ具体的な情報を含むこと

### 互換性

- NFR-301: 既存のwindows-version、windows-language設定との後方互換性を維持すること
- NFR-302: 新しい設定形式への移行が段階的に行えること

## Edgeケース

### エラー処理

- EDGE-001: 指定されたAMI IDが存在しない場合の適切なエラーハンドリング
- EDGE-002: 指定されたSSMパラメータが存在しない場合のエラーハンドリング
- EDGE-003: 指定されたインスタンスタイプが利用不可な場合のエラーハンドリング
- EDGE-004: cdk.jsonの設定値が不正な形式の場合のエラーハンドリング

### 境界値

- EDGE-101: 非常に長いAMI IDまたはパラメータパスが指定された場合の処理
- EDGE-102: サポートされていないインスタンスタイプが指定された場合の処理
- EDGE-103: 複数の設定方法が同時に指定された場合の優先順位

### データ整合性

- EDGE-201: AMI設定とインスタンスタイプの組み合わせが不適切な場合の検証
- EDGE-202: Linux AMIが指定されているにも関わらずWindows用設定が残っている場合の処理

## 受け入れ基準

### 機能テスト

- [ ] cdk.jsonで直接AMI IDを指定してインスタンスが正常に作成される
- [ ] cdk.jsonでSSMパラメータパスを指定してインスタンスが正常に作成される
- [ ] cdk.jsonで任意のインスタンスタイプを指定してインスタンスが正常に作成される
- [ ] AMI設定が未指定の場合にデフォルトAMIが使用される
- [ ] インスタンスタイプが未指定の場合にデフォルトインスタンスタイプが使用される
- [ ] 既存のwindows-version/windows-language設定で引き続き動作する
- [ ] Windows AMI使用時にRDP設定が正常に適用される
- [ ] Linux AMI使用時にWindows特有の設定が適用されない

### 非機能テスト

- [ ] 不正なAMI ID指定時に適切なエラーメッセージが表示される
- [ ] 不正なインスタンスタイプ指定時に適切なエラーメッセージが表示される
- [ ] SSMパラメータアクセスエラー時に適切なエラーメッセージが表示される
- [ ] AMI取得処理が30秒以内に完了する
- [ ] SSM Session Manager接続が正常に動作する

### 設定例テスト

- [ ] 以下の設定例が正常に動作することを確認
  ```json
  {
    "context": {
      "ami-id": "ami-0123456789abcdef0",
      "instance-type": "t3.large"
    }
  }
  ```
- [ ] 以下の設定例が正常に動作することを確認
  ```json
  {
    "context": {
      "ami-parameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2",
      "instance-type": "m5.xlarge"
    }
  }
  ```